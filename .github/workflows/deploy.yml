# =============================================================================
# VidScribe - GitHub Actions CI/CD Workflow
# =============================================================================
# Automated testing and deployment pipeline for VidScribe infrastructure.
#
# Triggers:
#   - Pull requests to main: Run tests and Terraform plan
#   - Push to main: Run tests, plan, and apply
#
# Required Secrets:
#   - AWS_ACCESS_KEY_ID: AWS access key for deployment
#   - AWS_SECRET_ACCESS_KEY: AWS secret key for deployment
#   - TF_STATE_BUCKET: S3 bucket name for Terraform state
#   - TF_LOCK_TABLE: DynamoDB table name for state locking
#
# Optional Secrets (for initial deployment):
#   - TF_VAR_YOUTUBE_API_KEY: YouTube Data API key
#   - TF_VAR_LLM_API_KEY: Gemini or Groq API key
#   - WEBSHARE_USERNAME: Webshare proxy username (mapped to TF_VAR_webshare_username)
#   - WEBSHARE_PASSWORD: Webshare proxy password (mapped to TF_VAR_webshare_password)
# =============================================================================

name: Deploy VidScribe

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: eu-west-1
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.6.0"

jobs:
  # ---------------------------------------------------------------------------
  # Test Job - Run Python tests
  # ---------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: github.event_name == 'push'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Build Job - Build Lambda packages
  # ---------------------------------------------------------------------------
  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build Lambda layers
        run: |
          chmod +x scripts/build_layers.sh
          ./scripts/build_layers.sh

      - name: Print layer hash
        run: sha256sum packages/dependencies-layer.zip

      - name: Upload Lambda Layer
        uses: actions/upload-artifact@v4
        with:
          name: lambda-layers
          path: packages/dependencies-layer.zip
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Terraform Plan Job
  # ---------------------------------------------------------------------------
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create packages directory
        run: mkdir -p packages
      
      - name: Download Lambda Layer
        uses: actions/download-artifact@v4
        with:
          name: lambda-layers
          path: packages/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        working-directory: infra
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="region=${{ env.AWS_REGION }}"
      
      - name: Terraform Validate
        working-directory: infra
        run: terraform validate
      
      - name: Terraform Plan
        working-directory: infra
        run: |
          terraform plan -out=tfplan \
            -var="youtube_api_key=${{ secrets.TF_VAR_YOUTUBE_API_KEY || 'PLACEHOLDER' }}" \
            -var="llm_api_key=${{ secrets.TF_VAR_LLM_API_KEY || 'PLACEHOLDER' }}"
        env:
          TF_VAR_sender_email: ${{ vars.SENDER_EMAIL || '' }}
          TF_VAR_destination_email: ${{ vars.DESTINATION_EMAIL || '' }}
          TF_VAR_admin_email: ${{ vars.ADMIN_EMAIL || '' }}
          TF_VAR_summarization_language: ${{ vars.SUMMARIZATION_LANGUAGE || 'English' }}
          # Proxy configuration
          TF_VAR_proxy_type: ${{ vars.PROXY_TYPE || 'none' }}
          TF_VAR_webshare_username: ${{ secrets.WEBSHARE_USERNAME }}
          TF_VAR_webshare_password: ${{ secrets.WEBSHARE_PASSWORD }}
          TF_VAR_generic_proxy_http_url: ${{ secrets.GENERIC_PROXY_HTTP_URL }}
          TF_VAR_generic_proxy_https_url: ${{ secrets.GENERIC_PROXY_HTTPS_URL }}
          # Gmail SMTP configuration (optional)
          TF_VAR_use_gmail_smtp: ${{ vars.USE_GMAIL_SMTP || 'false' }}
          TF_VAR_gmail_sender: ${{ vars.GMAIL_SENDER || '' }}
          TF_VAR_gmail_app_password: ${{ secrets.GMAIL_APP_PASSWORD }}
      
      - name: Upload Deployment Bundle
        uses: actions/upload-artifact@v4
        with:
          name: deployment-bundle
          path: |
            infra/tfplan
            packages/*.zip
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Terraform Apply Job (only on push to main)
  # ---------------------------------------------------------------------------
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create packages directory
        run: mkdir -p packages
      
      - name: Download Deployment Bundle
        uses: actions/download-artifact@v4
        with:
          name: deployment-bundle
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        working-directory: infra
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="region=${{ env.AWS_REGION }}"
      
      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve tfplan
      
      - name: Output Deployment Info
        working-directory: infra
        run: |
          echo "## Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lambda Functions:" >> $GITHUB_STEP_SUMMARY
          terraform output -raw lambda_poller_name >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output -raw lambda_processor_name >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output -raw lambda_newsletter_name >> $GITHUB_STEP_SUMMARY
